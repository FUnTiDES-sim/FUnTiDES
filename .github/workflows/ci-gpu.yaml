name: CI-GPU

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

  # TODO RUN after CPU only if success
on:
  pull_request:
    branches:
      - main

  workflow_dispatch: # Allow to start this workflow manually

jobs:

  build:
    runs-on: hpc-us
    strategy:
      matrix:
        partition: [maple_mig, cypress_dgx] # TODO add cypres
        #discretization: [fd, sem] TODO always build both
        discretization: [fd]
        #pywrap: [pywrap-on, pywrap-off] TODO activate python
        pywrap: [pywrap-off]
        #programming_model: [vector, kokkos] TODO activate vector
        programming_model: [kokkos]
        exclude:
        # Exclude Vector + Python (wrappers use Kokkos)
        - programming_model: vector
          pywrap: pywrap-on

      max-parallel: 5

    continue-on-error: true # We want to run other builds even if some build fails

    steps:

      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # FOR MAPLE
      - name: Submit Slurm H200
        if: ${{ matrix.partition != 'cypress_dgx' }}
        uses: ./.github/actions/slurm-submit
        env:
          SLURM_PARTITION: ${{ matrix.partition }}
          DISCRETIZATION: ${{ matrix.discretization }}
          PYWRAP: ${{ matrix.pywrap }}
          PROGRAMMING_MODEL: ${{ matrix.programming_model }}
        with:
          job-name: funtides-${{ matrix.partition }}-${{ matrix.discretization }}-${{ matrix.pywrap }}-${{ matrix.programming_model }}
          partition: ${{ matrix.partition }}
          run-script: |
            ./.github/scripts/build_and_test.sh

      # FOR CYPRESS
      - name: Allocate Slurm A100
        if: ${{ matrix.partition == 'cypress_dgx' }}
        uses: ./.github/actions/slurm-salloc
        env:
          SLURM_PARTITION: ${{ matrix.partition }}
          DISCRETIZATION: ${{ matrix.discretization }}
          PYWRAP: ${{ matrix.pywrap }}
          PROGRAMMING_MODEL: ${{ matrix.programming_model }}
        with:
          job-name: funtides-${{ matrix.partition }}-${{ matrix.discretization }}-${{ matrix.pywrap }}-${{ matrix.programming_model }}
          run-script: |
            ./.github/scripts/build_and_test.sh